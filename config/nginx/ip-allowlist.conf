# ========================================
# SENTINENTX NGINX IP ALLOWLIST
# ========================================
# Kopyala: sudo cp config/nginx/ip-allowlist.conf /etc/nginx/conf.d/ip-allowlist.conf

server {
    listen 80;
    server_name sentx.example.com;

    root /var/www/sentx/public;
    index index.php index.html;

    # API/Panel erişimini IP ile kısıtla (örnek)
    location /admin {
        allow 203.0.113.10;   # ofis
        allow 198.51.100.42;  # vpn
        deny all;
        try_files $uri $uri/ /index.php?$query_string;
    }

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
    }
}

# Güvenli IP aralıkları (güncelle)
geo $allowed_ip {
    default 0;
    
    # Office IP'leri
    192.168.1.0/24 1;      # Office LAN
    10.0.0.0/8 1;          # Office VPN
    
    # Home IP'leri
    203.0.113.0/24 1;      # Home office
    198.51.100.0/24 1;     # Backup location
    
    # Cloud provider IP'leri
    52.0.0.0/8 1;          # AWS
    35.0.0.0/8 1;          # Google Cloud
    13.0.0.0/8 1;          # Azure
    
    # Monitoring IP'leri
    8.8.8.8 1;              # Google DNS
    1.1.1.1 1;              # Cloudflare DNS
}

# Rate limiting tanımları
limit_req_zone $binary_remote_addr zone=trading:10m rate=10r/m;
limit_req_zone $binary_remote_addr zone=api:10m rate=60r/m;
limit_req_zone $binary_remote_addr zone=general:10m rate=100r/m;

# Genel rate limiting
location / {
    limit_req zone=general burst=20 nodelay;
    try_files $uri $uri/ /index.php?$query_string;
}
